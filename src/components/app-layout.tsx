
'use client';

import Link from 'next/link';
import { BarChart3, LogOut, Users, User as UserIcon, Cog } from 'lucide-react';
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuLabel,
    DropdownMenuSeparator,
    DropdownMenuTrigger,
  } from '@/components/ui/dropdown-menu';
import { useAuth } from '@/context/auth-context';
import { Button } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';
import { Avatar, AvatarFallback, AvatarImage } from './ui/avatar';
import { ThemeSwitcher } from './theme-switcher';

export function AppLayout({ children }: { children: React.ReactNode }) {
  const { logout, user } = useAuth();

  return (
    <>
      <header className="py-4 px-4 sm:px-6 lg:px-8 flex items-center justify-between gap-4">
        <div className="flex items-center gap-4">
          <Link href="/" className="flex items-center gap-4">
            <div className="w-32 h-auto">
              <svg viewBox="0 0 550 340" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M515.341 12.3418C526.452 4.90176 539.066 3.01163 549.952 3.01163C552.072 3.01163 552.122 6.04184 550.002 6.14184C431.002 12.2418 35.3022 5.74184 10.0022 173.142C-15.2978 340.542 391.202 360.242 536.802 173.142C539.142 169.582 541.332 165.712 543.502 161.842C549.202 151.842 523.541 118.842 516.341 126.942C399.141 258.842 90.8418 274.642 75.3418 173.142C60.2418 73.7418 368.141 -29.8582 515.341 12.3418Z" fill="#FBE122"/>
                <path d="M510.133 26.5418C377.733 -19.4582 76.5332 76.2418 89.2332 173.142C101.933 270.042 388.533 259.942 505.733 128.042C512.933 120.942 531.023 151.722 525.323 161.722C518.233 174.042 511.123 185.392 503.233 196.242C374.333 346.542 -5.56678 322.742 1.33322 173.142C8.23322 23.5418 377.733 -19.4582 510.133 26.5418Z" fill="#ED3237"/>
                <path d="M410.957 149.378C410.017 149.278 409.027 149.178 408.017 149.178C405.217 149.178 402.667 149.628 400.367 150.528C398.067 151.428 396.157 152.708 394.637 154.368C393.117 156.028 392.017 157.988 391.337 160.248C390.657 162.508 390.317 164.988 390.317 167.688C390.317 171.888 391.217 175.488 393.017 178.488C394.817 181.488 397.267 183.638 400.367 184.938C403.467 186.238 406.967 186.888 410.867 186.888C413.567 186.888 416.017 186.488 418.217 185.688C420.417 184.888 422.317 183.788 423.917 182.388C425.517 180.988 426.767 179.338 427.667 177.438C428.567 175.538 429.017 173.438 429.017 171.138C429.017 170.138 428.917 169.188 428.717 168.288C428.517 167.388 428.167 166.588 427.667 165.888C426.067 163.488 423.467 161.838 419.867 160.938L426.517 127.888L413.917 126.388L408.817 153.188C406.717 151.388 404.067 150.088 400.867 149.288L410.957 149.378ZM410.867 180.288C408.067 180.288 405.867 179.388 404.267 177.588C402.667 175.788 401.867 173.188 401.867 169.788C401.867 166.288 402.767 163.538 404.567 161.538C406.367 159.538 408.667 158.538 411.467 158.538C412.367 158.538 413.267 158.638 414.167 158.838C415.067 159.038 415.867 159.338 416.567 159.738C417.267 160.138 417.867 160.588 418.367 161.088C418.867 161.588 419.267 162.138 419.567 162.738C419.167 164.838 418.967 167.038 418.967 169.338C418.967 173.038 418.167 175.888 416.567 177.888C414.967 179.888 413.117 180.288 410.867 180.288Z" fill="#FBE122"/>
                <path d="M228.691 167.688C228.691 164.188 228.991 161.088 229.591 158.388C230.191 155.588 230.991 153.288 231.991 151.488C233.091 149.688 234.291 148.288 235.591 147.288C236.991 146.288 238.391 145.688 239.791 145.488C241.191 145.188 242.591 145.088 243.991 145.188C246.191 145.188 248.091 145.688 249.691 146.688C251.291 147.688 252.491 149.088 253.291 150.888C254.091 152.688 254.491 154.788 254.491 157.188C254.491 158.988 254.191 160.788 253.591 162.588C252.991 164.388 252.091 165.988 250.891 167.388C249.691 168.788 248.291 169.888 246.691 170.688C245.091 171.488 243.391 171.888 241.591 171.888C239.591 171.888 237.791 171.388 236.191 170.388C234.591 169.388 233.291 168.288 232.291 166.888L233.191 173.388L228.691 174.088V167.688ZM241.891 166.388C243.991 166.388 245.691 165.588 246.991 163.988C248.291 162.388 248.891 160.188 248.891 157.388C248.891 154.688 248.291 152.588 247.091 151.088C245.891 149.588 244.291 148.788 242.291 148.788C240.291 148.788 238.691 149.588 237.491 151.188C236.291 152.788 235.691 154.788 235.691 157.188C235.691 159.888 236.291 161.988 237.491 163.488C238.691 164.988 240.191 166.388 241.891 166.388Z" fill="#FBE122"/>
                <path d="M303.882 149.288C303.882 145.788 304.182 142.688 304.782 139.988C305.382 137.188 306.182 134.888 307.182 133.088C308.282 131.288 309.482 129.888 310.782 128.888C312.182 127.888 313.582 127.288 314.982 127.088C316.382 126.788 317.782 126.688 319.182 126.788C321.382 126.788 323.282 127.288 324.882 128.288C326.482 129.288 327.682 130.688 328.482 132.488C329.282 134.288 329.682 136.388 329.682 138.788C329.682 140.588 329.382 142.388 328.782 144.188C328.182 145.988 327.282 147.588 326.082 148.988C324.882 150.388 323.482 151.488 321.882 152.288C320.282 153.088 318.582 153.488 316.782 153.488C314.782 153.488 312.982 152.988 311.382 151.988C309.782 150.988 308.482 149.888 307.482 148.488L308.382 154.988L303.882 155.688V149.288ZM317.082 151.988C319.182 151.988 320.882 151.188 322.182 149.588C323.482 147.988 324.082 145.788 324.082 142.988C324.082 140.288 323.482 138.188 322.282 136.688C321.082 135.188 319.482 134.388 317.482 134.388C315.482 134.388 313.882 135.188 312.682 136.788C311.482 138.388 310.882 140.388 310.882 142.788C310.882 145.488 311.482 147.588 312.682 149.088C313.882 150.588 315.382 151.988 317.082 151.988Z" fill="#FBE122"/>
                <path d="M266.625 126.888H281.425V149.088H266.625V145.188H277.025V139.688H267.525V135.788H277.025V130.788H266.625V126.888Z" fill="#FBE122"/>
                <path d="M344.417 127.888L339.217 149.088H333.617L338.817 127.888H344.417Z" fill="#FBE122"/>
                <path d="M198.538 127.788H187.638V149.088H198.538V145.188H192.238V139.688H197.638V135.788H192.238V131.688H198.538V127.788Z" fill="#FBE122"/>
                <path d="M176.629 212.788L171.429 233.988H165.829L171.029 212.788H176.629Z" fill="#FFFFFF"/>
                <path d="M211.52 212.788H200.62V233.988H211.52V230.088H205.22V224.588H210.62V220.688H205.22V216.588H211.52V212.788Z" fill="#FFFFFF"/>
                <path d="M228.463 212.788H217.563V233.988H228.463V230.088H222.163V224.588H227.563V220.688H222.163V216.588H228.463V212.788Z" fill="#FFFFFF"/>
                <path d="M187.572 212.788H193.172L184.272 233.988H178.672L187.572 212.788Z" fill="#FFFFFF"/>
                <path d="M246.705 212.788H252.305L243.405 233.988H237.805L246.705 212.788Z" fill="#FFFFFF"/>
                <path d="M259.648 212.788H265.248L256.348 233.988H250.748L259.648 212.788Z" fill="#FFFFFF"/>
                <path d="M285.492 125.04C286.082 124.69 286.662 124.39 287.242 124.14C287.252 123.86 287.262 123.58 287.262 123.3C287.262 122.95 287.232 122.61 287.162 122.27C287.102 121.93 287.012 121.58 286.892 121.23C286.772 120.88 286.622 120.53 286.442 120.19C285.832 119.05 285.122 117.97 284.312 116.94C283.502 115.91 282.602 114.96 281.612 114.1C279.792 112.52 277.702 111.33 275.342 110.53C272.982 109.73 270.462 109.33 267.782 109.33C265.732 109.33 263.742 109.64 261.812 110.26C259.882 110.88 258.072 111.78 256.382 112.96C254.692 114.14 253.162 115.58 251.792 117.29C250.422 118.99 249.252 120.91 248.282 123.04C248.722 122.9 249.172 122.77 249.632 122.65C250.092 122.53 250.552 122.41 251.012 122.29C251.482 122.17 251.932 122.02 252.382 121.84C253.792 121.23 255.152 120.61 256.452 119.98C258.412 119.01 260.182 118.06 261.762 117.14C263.342 116.22 264.682 115.36 265.782 114.56C267.432 113.34 268.822 112.26 269.952 111.32C271.082 110.38 271.912 109.58 272.442 108.92C272.972 108.26 273.192 107.69 273.102 107.22C273.012 106.75 272.632 106.33 271.962 105.97C271.292 105.61 270.362 105.24 269.172 104.86C267.982 104.48 266.582 104.14 264.972 103.84C263.362 103.54 261.622 103.26 259.752 103.01C258.482 102.82 257.192 102.65 255.882 102.51C254.572 102.37 253.252 102.26 251.922 102.18C250.602 102.1 249.292 102.04 247.992 102.01C246.692 101.98 245.412 101.97 244.152 101.98C241.012 102.02 238.102 102.48 235.422 103.36C232.742 104.24 230.342 105.51 228.222 107.17C226.102 108.83 224.322 110.84 222.882 113.2C221.442 115.56 220.392 118.21 219.732 121.15C219.072 124.09 218.742 127.24 218.742 130.6C218.742 133.04 218.992 135.41 219.492 137.71C219.992 140.01 220.722 142.18 221.682 144.22C222.642 146.26 223.802 148.13 225.162 149.83C226.522 151.53 228.052 153.01 229.752 154.27C230.632 154.91 231.542 155.51 232.482 156.07C233.422 156.63 234.362 157.13 235.302 157.57C236.242 158.01 237.172 158.39 238.092 158.71C239.012 159.03 239.912 159.29 240.792 159.49C241.672 159.69 242.532 159.83 243.372 159.91C244.212 159.99 245.022 160.03 245.802 160.03C248.542 160.03 251.072 159.61 253.392 158.77C255.712 157.93 257.772 156.73 259.572 155.17C261.372 153.61 262.882 151.74 264.102 149.56C265.322 147.38 266.212 144.97 266.772 142.33C267.332 139.69 267.612 136.88 267.612 133.9C267.612 131.67 267.362 129.56 266.862 127.57C267.692 127.38 268.522 127.18 269.352 126.97C270.182 126.76 271.002 126.53 271.812 126.28C272.622 126.03 273.412 125.77 274.182 125.5C282.612 122.99 285.492 125.04 285.492 125.04Z" fill="#FFFFFF"/>
              </svg>
            </div>
            <div>
                <h1 className="text-3xl font-bold tracking-tight text-primary font-headline">
                Gerenciador Pema
                </h1>
                <p className="text-muted-foreground">Sistema de Ponto de Venda</p>
            </div>
          </Link>
        </div>
        <div className="flex items-center gap-4">
          {user?.role === 'admin' && (
            <>
              <Button asChild>
                  <Link href="/users">
                      <Users className="mr-2"/>
                      Gerenciar Usuários
                  </Link>
              </Button>
              <ThemeSwitcher />
            </>
          )}
          {user?.role !== 'vendedor' && (
            <Button asChild>
                <Link href="/reports">
                <BarChart3 className="mr-2" />
                Ver Relatórios
                </Link>
            </Button>
          )}

          <DropdownMenu>
            <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative h-10 w-10 rounded-full">
                    <Avatar className="h-10 w-10">
                        <AvatarImage src={user?.avatarUrl} alt={user?.username} />
                        <AvatarFallback>
                            <UserIcon />
                        </AvatarFallback>
                    </Avatar>
                </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent className="w-56" align="end" forceMount>
              <DropdownMenuLabel className="font-normal">
                <div className="flex flex-col space-y-1">
                  <p className="text-sm font-medium leading-none">{user?.username}</p>
                  <p className="text-xs leading-none text-muted-foreground">
                    {user?.role}
                  </p>
                </div>
              </DropdownMenuLabel>
              <DropdownMenuSeparator />
              <DropdownMenuItem asChild>
                <Link href="/profile">
                    <Cog className="mr-2" />
                    Editar Perfil
                </Link>
              </DropdownMenuItem>
              <DropdownMenuItem onClick={logout}>
                <LogOut className="mr-2" />
                Sair
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </header>
      <Separator className="mb-4" />
      <div className="px-4 sm:px-6 lg:px-8 pt-0">{children}</div>
    </>
  );
}
